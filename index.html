<!DOCTYPE html>
<html>
<head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
    <title>Invention Gallery</title>
    <script src="https://s3.amazonaws.com/stitch-sdks/js/bundles/4.6.0/stitch.js"></script>

</head>

<body>

<h2>Invention Gallery</h2>

    Name: <input type="text" id="name" style="border:2px solid DodgerBlue;" >

    <button class="button" onclick="addUser()" value="addUser">Add</button>
    <button class="button" onclick="deleteUser()" value="deleteUser">Delete</button>
    <button class="button" onclick="login()" value="login">Login</button>


    <script>
        const client = stitch.Stitch.initializeDefaultAppClient('hw2-app-kktvp');
        const db = client.getServiceClient(stitch.RemoteMongoClient.factory, 'mongodb-atlas').db('ceng495_hw2_db');
      
        client.auth.loginWithCredential(new stitch.AnonymousCredential()).then(user =>
          db.collection('users').find({owner_id: client.auth.user.id}, { limit: 100}).asArray()
        ).then(docs => {
            console.log("Found docs", docs)
            console.log(client.auth.user.id)
            console.log("[MongoDB Stitch] Connected to Stitch")
        }).catch(err => {
          console.error(err)
        });
    </script>

    <script>

        function addUser(){
            db.collection('users').findOne({user_name: document.getElementById("name").value}).then(function(result){
                if(result != null){
                    alert("User already exists");              
                }
                else if(document.getElementById("name").value === ""){
                    alert("Name section cannot be empty.");                      
                }
                else{
                    //console.log("gonna add the user");
                    db.collection('users').insertOne({user_name: document.getElementById("name").value, inventions: []})
                    .then(docs => {
                    console.log("Found docs", docs)
                    }).catch(err => {
                    console.error(err)
                    });  
                    alert("User is added");
                }
            });
        }
    
        function deleteUser(){
            var myDocument = db.collection('users').findOne({user_name: document.getElementById("name").value});
            myDocument.then(function(result){
                if(result != null){
                    client.auth.loginWithCredential(new stitch.AnonymousCredential()).then(user =>
                    db.collection('users').deleteOne({user_name: document.getElementById("name").value})
                    .catch(err => {
                    console.error(err)
                    }));
                    alert("User deleted.");              
                }
                else{
                    alert("There is no such a user.");
                }
            });
        }
    
        function login(){
            const loginName = document.getElementById("name").value;
            document.getElementById("name").value = "";
            var myDocument = db.collection('users').findOne({user_name: loginName});
        
            myDocument.then(function(result){
                if(result != null){
                    loadUrl("./user.html?name=" + loginName);
                }
                else{
                    alert("There is no such a user.");
                }
            });
        }
    
        function loadUrl(newLocation){
            window.location = newLocation;
            return false;
        }
    
    
    </script>

</body>
</html>