<!DOCTYPE html>
<html>

<head>
  <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
  <meta content="utf-8" http-equiv="encoding">
  <title>Invention Gallery Profile</title>
  <link rel="stylesheet" href="./styles/style.css" type="text/css"/>
  <script src="https://s3.amazonaws.com/stitch-sdks/js/bundles/4.6.0/stitch.js"></script>
</head>

<body>

  <div class="user-header">
    <h2 id="username"></h2>
    <h2 id="userRating"></h2>
  </div>

  <div class="add-invention">
    <p>Exhibit New Invention</p>

    <input type="text" placeholder="Invention Name" id="productName">
    <h1></h1>
    <input type="text" placeholder="Photo Link" id="productPhoto">
    <h1></h1>
    <input type="text" placeholder="Cost" id="productCost">
    <h1></h1>
    <input type="text" placeholder="Material(s)" id="productMaterial">
    <h1></h1>
    <input type="text" placeholder="Optional Field 1" id="optionalKey1">:
    <input type="text" placeholder="Optional Field 1" id="optionalValue1">
    <h1></h1>
    <input type="text" placeholder="Optional Field 2" id="optionalKey2">:
    <input type="text" placeholder="Optional Field 2" id="optionalValue2">
    <h1></h1>
    <button class="button" onclick="addInvention()" value="addInvention">Add Invention</button>
  </div>

  <div class="gallery">

    <p>Invention Gallery</p>
    <div id="allInventions"></div>
    
  </div>

  <div>
    <button class="button" onclick="toHomepage()">Back to Home</button>
  </div>

  <script>
    const client = stitch.Stitch.initializeDefaultAppClient('hw2-app-kktvp');
    const db = client.getServiceClient(stitch.RemoteMongoClient.factory, 'mongodb-atlas').db('ceng495_hw2_db');
    const name = (new URL(window.location.href)).searchParams.get("name");
    const criteria = { user_name: name }
  
  </script>

  <script>

    function getRating(){
      var sum = 0;
      var myDocument = db.collection('users').findOne(criteria);
      myDocument.then(function (result) {
        if (result != null) {

          var products = result.inventions;
          for(var i=0; i < products.length; i++){
            sum += products[i].totalRating;
          }
          sum = sum / products.length;
        }
      });
      return sum;
    }

    function displayProducts(productList, elementId){
      var i=0;
      while(productList[i]){
        
        if(productList[i].isVisible){
          var product_name = productList[i].productName; 
          var product_img = productList[i].productPhoto;

          var link = document.createElement("a");
          var img = document.createElement("img");
          img.src = product_img;
          var text = document.createElement("h3");
          text.innerHTML = product_name;

          link.id = "product";
          img.id = "product-img";
          text.id = "product-text";
          
          link.appendChild(img);
          link.append(text);

          document.getElementById(elementId).appendChild(link);

        }
        i++;
      }
    }

    function addInvention() {
      var myDocument = db.collection('users').findOne(criteria);
      myDocument.then(function (result) {

        if (result != null) {

          if(document.getElementById("productName").value == "" || document.getElementById("productPhoto").value == "" ||
          document.getElementById("productCost").value == "" || document.getElementById("productMaterial").value == ""){
            
            alert("Fill the form completely.");
          }

          else{
            // What to do with optional elements ?? 
            var products = result.inventions;
            var productNameArray = document.getElementById("productName").value;
            var product_name = productNameArray.split(" ").join("");
  
            var new_product = {
              productName: product_name, productPhoto: document.getElementById("productPhoto").value, 
              productCost: document.getElementById("productCost").value, productMaterial: document.getElementById("productMaterial").value,
              ratings: [], totalRating: 0, isVisible: true
            };

            products.push(new_product);
            var updateProducts = { inventions: products };
            db.collection('users').updateOne(criteria, { $set: updateProducts });
            console.log("New item added.")
            }
          
          clearForm();
        }
      });
    }

    function clearForm(){
      document.getElementById("productName").value = "";
      document.getElementById("productPhoto").value = "";
      document.getElementById("productCost").value = "";
      document.getElementById("productMaterial").value = "";
      document.getElementById("optionalKey1").value = "";
      document.getElementById("optionalValue1").value = "";
      document.getElementById("optionalKey2").value = "";
      document.getElementById("optionalValue2").value = "";
    }

    function getEventTarget(e) {
        e = e || window.event;
        return e.target || e.srcElement; 
    }

    function loadUrl(newLocation){
      window.location = newLocation;
      return false;
    }

    function toHomepage(){
      loadUrl("./index.html");
    }

  </script>

  <script>

    document.getElementById('username').innerHTML = "Username: " + name;
    document.getElementById('userRating').innerHTML = "Rating: " + getRating();

    var allDocuments = db.collection('users').find().toArray();
    allDocuments.then(function (result){
      var i=0;
      while(result[i]){
        var productList = result[i].inventions;
        displayProducts(productList, "allInventions"); 
        i++;
      }
    });

    var ul = document.getElementById("allInventions");
    ul.onclick = function(event) {
        var target = getEventTarget(event);
        if(target.innerHTML != "")
        {
        console.log(target.innerHTML);
	    	const newURL = "./invention.html?name=" + name + "&pname=" + target.innerHTML;
	    	loadUrl(newURL);
        }
    };



  </script>

</body>

</html>